using Microsoft.AspNetCore.Mvc;
using Microsoft.Extensions.Logging;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Farmerce.Models;
using System.Net;
using System.Net.Mail;
using Farmerce.Data;

namespace Farmerce.Controllers
{
    public class OrderFormController : Controller
    {
        private readonly ApplicationDbContext _context;
        public OrderFormController(ApplicationDbContext context)
        {
            _context = context;
        }

        public IActionResult OrderForm()
        {
            return View();
        }
        [HttpPost]
        public IActionResult OrderForm(OrderForm record)
        {
            MailMessage mail = new MailMessage()
            {
                From = new MailAddress("mvcapplicationtestrun@gmail.com", "AutoGeneratedText(DoNotReply)")
            };
            mail.To.Add(new MailAddress(record.emailAddress));

            mail.Subject = "Inquiry from " + record.fullName + " (" + "Item purchased" + ")";
            string message = "Hello," + record.fullName + "<br/><br/>"
                + "Thank you for purchasing. Here are the items that you have purchased <br/><br/>"
                + "Items: " + record.itemBuy + "<br/><br/>" + "Item is being processed Thank you.";
            mail.Body = message;
            mail.IsBodyHtml = true;

            using SmtpClient smtp = new SmtpClient("smtp.gmail.com", 587)
            {
                Credentials = new NetworkCredential("mvcapplicationtestrun@gmail.com", "4D302EB5AC0A121C4F570594EE0E43001B959AAD5F273CE16AF694A1A05B2B56"),
                EnableSsl = true
            };
            smtp.Send(mail);
            ViewBag.Message = "Submitted.";
            return View();
        }
    }
}
